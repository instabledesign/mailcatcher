package main

import (
	"context"
	"fmt"
	"github.com/instabledesign/mailcatcher/internal"
	"log"

	internal_config "github.com/instabledesign/mailcatcher/config"
	"github.com/instabledesign/mailcatcher/internal/server/http"
	"github.com/instabledesign/mailcatcher/internal/server/smtp"
	"github.com/instabledesign/mailcatcher/internal/service"
	"github.com/instabledesign/mailcatcher/pkg/config"
	"github.com/gol4ng/stop-dispatcher/stop_emitter"
)

const Name = "mailcatcher"

var Version = "wip"

func main() {
	fmt.Printf("Starting %s@%s\n", Name, Version)

	mainCtx, mainCancel := context.WithCancel(context.Background())
	cfg := internal_config.NewConfig()
	fmt.Println(config.TableString(cfg))

	container := service.NewContainer(cfg, mainCtx)
	l := container.GetLogger()

	mailStorage := container.GetMailStorage()
	mailStorage.Handle(&internal.Mail{
		User: &internal.LoggedUser{Username: "myusername", Password: "mypass"},
		From: "anto@test.com",
		Tos:  []string{"destA1@test.com", "destA2@test.com"},
		Data: "Delivered-To: instabledesign@gmail.com\nReceived: by 2002:a9d:187:0:0:0:0:0 with SMTP id e7csp1304939ote;\n        Sat, 25 Sep 2021 03:34:43 -0700 (PDT)\nX-Google-Smtp-Source: ABdhPJwgy+ngk0M4wjBOdO8hTvhix/AYWXKb67zJuHtXdKnEyLn7WHuMnp3fwpPHrkdPHltbjVXkd56Cu1w=\nX-Received: by 2002:a05:6808:1a11:: with SMTP id bk17mr5222506oib.0.1632566082974;\n        Sat, 25 Sep 2021 03:34:42 -0700 (PDT)\nAuthentication-Results: mx.google.com;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4\nReceived-SPF: pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) client-ip=46.105.148.180;\nReceived: by 2002:a4a:d69a:: with POP3 id i26mf2864967oot.2;\n        Sat, 25 Sep 2021 03:34:42 -0700 (PDT)\nX-Gmail-Fetch-Info: depotdesign@gmail.com 3 pop.gmail.com 995 depotdesign@gmail.com\nDelivered-To: depotdesign@gmail.com\nReceived: by 2002:a05:6622:270e:0:0:0:0 with SMTP id m14csp1940853ivs;\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nX-Received: by 2002:a7b:ce94:: with SMTP id q20mr6609580wmj.83.1632564459475;\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nARC-Seal: i=1; a=rsa-sha256; t=1632564459; cv=none;\n        d=google.com; s=arc-20160816;\n        b=jVikbSLFvrHIu/X9QJElLBb2SY9rVmhxh36DX99rvf+SGSLAyj+i119f0QqAAERDyq\n         m6zQ9NeALhTgP2Tu+SBw6D+EgNMdxTjWs3nsJb2suQWxy11SC67i0Fyhl4d7Y26Ae66T\n         9QBPNVulglS6YV6ZG6XeefIW1IUJQzyFf0DEcAsHiY1BqEIG1xewSIj8Png23xosGzFB\n         vTC2CHJgS1i8AkncpCGI17Tt0Yzk6uWMo9ilkD6hyxJeuanNBcE8njr4krOokF7D1cLc\n         np1Xwfz6CnZSUGsvzEmsKUhEWfO3xDsp+MpSHeJr/iTL+ePpfEjxgLhNy+az0Z+x7VuP\n         r2FA==\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\n        h=mime-version:to:from:subject:date:message-id:dkim-signature;\n        bh=Y8g+00LvhtQgtB4KB4evDRuASAhE8b2ffOmtweZ1QVg=;\n        b=be5u7EOhKNxNmxZ1L0R/5nohyK72crX48h1tAFmENglSTgrnRNC8krkKsrkYb+mxSu\n         +L++CzhcefTEUPvxpMKyOIjYlTD7y73cgcEflNijKdXblE7p2m+NRU9oouSHm5mU9jpD\n         ifYESYONr09/4SEJC3nFXW+NYqyZiqpd/HixWcfRrzZgPPsw/QiscbHw4PoSrFiSPXen\n         2WcLOoNP9ecMRDXylfQxSIf4xr9W1z6a5RLC/Qjhmo3Wcn9NS9EfVjkf60VEhv8YrhL7\n         6bNlAC4s9DOLZ1k8LLbluqh15A+EG3npdv5jPk8gQ+0KLCHpM68W4S0/T5l1WB4LwpIi\n         LgQQ==\nARC-Authentication-Results: i=1; mx.google.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=boondmanager.com\nReturn-Path: <no-reply@boondmanager.com>\nReceived: from boondmanager.com (app.boondmanager.com. [46.105.148.180])\n        by mx.google.com with ESMTPS id h189si16928071wmh.54.2021.09.25.03.07.39\n        for <depotdesign@gmail.com>\n        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nReceived-SPF: pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) client-ip=46.105.148.180;\nAuthentication-Results: mx.google.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=boondmanager.com\nReceived: from www.boondmanager.com (bmconsumera.boondmanager.com [192.168.0.100]) by boondmanager.com (Postfix) with ESMTPS id DF4701CC for <depotdesign@gmail.com>; Sat, 25 Sep 2021 12:07:38 +0200 (CEST)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=boondmanager.com; s=mail; t=1632564458; bh=QxEXo9UDvou2HpgkfjklgYK3pUA0Z3h/tAsHu4wPckc=; h=Date:Subject:From:To; b=UCaUbFV4Zzjm3iat2iwyyUMY+n59N3b4uRByx9cGneeWYm3oI8tc90PGIw4PpfS5B\n\t j+32lkmFDPvVTYi8gbEl2iqdrqJ4FlHsxZn6oFRcwcqTpjSurqPv44F4wo/qlY/FWk\n\t nPJovxTksZZELCk4hPY9wtLzvmfr5D6rgqYpmqKaWNhTyoL/PDatsiZL6kCGqB/OuI\n\t k+N1pFcFYmoN5wgHjrgx6W95Y8HI6HRORVyQPfUg3UCc8w+LG3mQiEzV1nyX/vx9l8\n\t n1swd/n218OorPZ2COOuGSluDcHVsWOhVuni4aBhAlNVDYJa8eIppGes6KGEXeLkGO\n\t jO09yfYEBS58A==\nReceived: from www-data (helo=bmconsumera) by www.boondmanager.com with local-smtp (Exim 4.92) (envelope-from <no-reply@boondmanager.com>) id 1mU4ao-000ROd-RK for depotdesign@gmail.com; Sat, 25 Sep 2021 12:07:38 +0200\nMessage-ID: <2bd79a797121796a5647b0595b4eda37@bmconsumera>\nDate: Sat, 25 Sep 2021 12:07:38 +0200\nSubject: Saisie des Temps\nFrom: BoondManager <no-reply@boondmanager.com>\nTo: Anthony MOUTTE <depotdesign@gmail.com>\nMIME-Version: 1.0\nContent-Type: multipart/alternative; boundary=\"_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\"\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\nContent-Type: text/plain; charset=utf-8\nContent-Transfer-Encoding: quoted-printable\n\nBonjour Anthony MOUTTE,\n\nVeuillez vous connecter =C3=A0 l'intranet de votre soci=C3=A9t=C3=A9, depui=\ns\nl'adresse suivante :\nhttps://ui.boondmanager.com?customerCode=3Dgroupeeleven afin de saisir\nvos temps du mois en cours.\n\nSi vous ne disposez pas de vos identifiants de connexion, veuillez\ncontacter votre responsable.\n\nMerci de ne pas r=C3=A9pondre =C3=A0 cet email.\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\nContent-Type: text/html; charset=utf-8\nContent-Transfer-Encoding: quoted-printable\n\n<!DOCTYPE html>\n<html lang=3D\"en\">\n<head>\n=09<meta charset=3D\"UTF-8\">\n=09<title>Title</title>\n=09<style>\n=09=09@media screen and (max-width:1200px) {\n=09=09=09.mobile {\n=09=09=09=09padding: 10px !important;\n=09=09=09=09font-size: 14px !important;\n=09=09=09}\n=09=09=09h2 {\n=09=09=09=09font-size:16px !important;\n=09=09=09}\n=09=09}\n=09</style>\n</head>\n<body class=3D'mobile' style=3D\"background-color: #EDF2FA;font-size: 14px;p=\nadding: 32px 48px 40px 48px;color: #707070;text-align: left;letter-spacing:=\n 0;\">\n=09<table class=3D'mobile'  style=3D\"font-family: Arial !important;max-widt=\nh: 887px;width: 100%;background-color: #FFFFFF;background-origin: padding-b=\nox;background-repeat: no-repeat;border-radius:08px;padding:40px;margin:auto=\n;\">\n=09=09=09=09<tr>\n=09=09=09<td width=3D\"100%\"><center><img style=3D\"margin-bottom: 40px;\" hei=\nght=3D\"40\" src=3D\"https://ui.boondmanager.com/img/_clients/groupeeleven/log=\no.png\" alt=3D\"logo\"></center></td>\n=09=09</tr>\n=09=09=09=09<tr >\n=09=09=09<td style=3D\"font-family: Arial !important;\">Bonjour Anthony MOUTT=\nE,<br />\n<br />\nVeuillez vous connecter =C3=A0 l'intranet de votre soci=C3=A9t=C3=A9, depui=\ns l'adresse suivante : https://ui.boondmanager.com?customerCode=3Dgroupeele=\nven afin de saisir vos temps du mois en cours.<br />\n<br />\nSi vous ne disposez pas de vos identifiants de connexion, veuillez contacte=\nr votre responsable.<br />\n<br />\nMerci de ne pas r=C3=A9pondre =C3=A0 cet email.</td>\n=09=09</tr>\n=09=09<tr height=3D\"40px\"><td>&nbsp;</td></tr>\n=09=09<tr>\n=09=09=09<td width=3D\"100%\" style=3D\"text-align: right; font-family: Arial =\n!important;\">\n=09=09=09=09<a href=3D\"https://www.boondmanager.com/\" style=3D\"text-decorat=\nion: none;color: #707070;\">\n=09=09=09=09=09<p style=3D\"font-size: 12px; display: inline-block; margin: =\n0px;\"><i>Powered by </i><span style=3D\"font-size: 14px; color: black;\"><str=\nong>Boond</strong></span><span style=3D\"font-size: 14px;color: #FEA500;\">Ma=\nnager</span></p>\n=09=09=09=09</a>\n=09=09=09</td>\n=09=09</tr>\n=09</table>\n=09<br><br>\n</body>\n</html>\n\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_--",
	})
	mailStorage.Handle(&internal.Mail{
		User: &internal.AnonymousUser{Username: "anon_"},
		From: "anto@test.com",
		Tos:  []string{"destB1@test.com", "destB2@test.com"},
		Data: "Delivered-To: instabledesign@gmail.com\nReceived: by 2002:a9d:187:0:0:0:0:0 with SMTP id e7csp1304939ote;\n        Sat, 25 Sep 2021 03:34:43 -0700 (PDT)\nX-Google-Smtp-Source: ABdhPJwgy+ngk0M4wjBOdO8hTvhix/AYWXKb67zJuHtXdKnEyLn7WHuMnp3fwpPHrkdPHltbjVXkd56Cu1w=\nX-Received: by 2002:a05:6808:1a11:: with SMTP id bk17mr5222506oib.0.1632566082974;\n        Sat, 25 Sep 2021 03:34:42 -0700 (PDT)\nAuthentication-Results: mx.google.com;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4\nReceived-SPF: pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) client-ip=46.105.148.180;\nReceived: by 2002:a4a:d69a:: with POP3 id i26mf2864967oot.2;\n        Sat, 25 Sep 2021 03:34:42 -0700 (PDT)\nX-Gmail-Fetch-Info: depotdesign@gmail.com 3 pop.gmail.com 995 depotdesign@gmail.com\nDelivered-To: depotdesign@gmail.com\nReceived: by 2002:a05:6622:270e:0:0:0:0 with SMTP id m14csp1940853ivs;\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nX-Received: by 2002:a7b:ce94:: with SMTP id q20mr6609580wmj.83.1632564459475;\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nARC-Seal: i=1; a=rsa-sha256; t=1632564459; cv=none;\n        d=google.com; s=arc-20160816;\n        b=jVikbSLFvrHIu/X9QJElLBb2SY9rVmhxh36DX99rvf+SGSLAyj+i119f0QqAAERDyq\n         m6zQ9NeALhTgP2Tu+SBw6D+EgNMdxTjWs3nsJb2suQWxy11SC67i0Fyhl4d7Y26Ae66T\n         9QBPNVulglS6YV6ZG6XeefIW1IUJQzyFf0DEcAsHiY1BqEIG1xewSIj8Png23xosGzFB\n         vTC2CHJgS1i8AkncpCGI17Tt0Yzk6uWMo9ilkD6hyxJeuanNBcE8njr4krOokF7D1cLc\n         np1Xwfz6CnZSUGsvzEmsKUhEWfO3xDsp+MpSHeJr/iTL+ePpfEjxgLhNy+az0Z+x7VuP\n         r2FA==\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\n        h=mime-version:to:from:subject:date:message-id:dkim-signature;\n        bh=Y8g+00LvhtQgtB4KB4evDRuASAhE8b2ffOmtweZ1QVg=;\n        b=be5u7EOhKNxNmxZ1L0R/5nohyK72crX48h1tAFmENglSTgrnRNC8krkKsrkYb+mxSu\n         +L++CzhcefTEUPvxpMKyOIjYlTD7y73cgcEflNijKdXblE7p2m+NRU9oouSHm5mU9jpD\n         ifYESYONr09/4SEJC3nFXW+NYqyZiqpd/HixWcfRrzZgPPsw/QiscbHw4PoSrFiSPXen\n         2WcLOoNP9ecMRDXylfQxSIf4xr9W1z6a5RLC/Qjhmo3Wcn9NS9EfVjkf60VEhv8YrhL7\n         6bNlAC4s9DOLZ1k8LLbluqh15A+EG3npdv5jPk8gQ+0KLCHpM68W4S0/T5l1WB4LwpIi\n         LgQQ==\nARC-Authentication-Results: i=1; mx.google.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=boondmanager.com\nReturn-Path: <no-reply@boondmanager.com>\nReceived: from boondmanager.com (app.boondmanager.com. [46.105.148.180])\n        by mx.google.com with ESMTPS id h189si16928071wmh.54.2021.09.25.03.07.39\n        for <depotdesign@gmail.com>\n        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);\n        Sat, 25 Sep 2021 03:07:39 -0700 (PDT)\nReceived-SPF: pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) client-ip=46.105.148.180;\nAuthentication-Results: mx.google.com;\n       dkim=pass header.i=@boondmanager.com header.s=mail header.b=UCaUbFV4;\n       spf=pass (google.com: domain of no-reply@boondmanager.com designates 46.105.148.180 as permitted sender) smtp.mailfrom=no-reply@boondmanager.com;\n       dmarc=pass (p=NONE sp=NONE dis=NONE) header.from=boondmanager.com\nReceived: from www.boondmanager.com (bmconsumera.boondmanager.com [192.168.0.100]) by boondmanager.com (Postfix) with ESMTPS id DF4701CC for <depotdesign@gmail.com>; Sat, 25 Sep 2021 12:07:38 +0200 (CEST)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=boondmanager.com; s=mail; t=1632564458; bh=QxEXo9UDvou2HpgkfjklgYK3pUA0Z3h/tAsHu4wPckc=; h=Date:Subject:From:To; b=UCaUbFV4Zzjm3iat2iwyyUMY+n59N3b4uRByx9cGneeWYm3oI8tc90PGIw4PpfS5B\n\t j+32lkmFDPvVTYi8gbEl2iqdrqJ4FlHsxZn6oFRcwcqTpjSurqPv44F4wo/qlY/FWk\n\t nPJovxTksZZELCk4hPY9wtLzvmfr5D6rgqYpmqKaWNhTyoL/PDatsiZL6kCGqB/OuI\n\t k+N1pFcFYmoN5wgHjrgx6W95Y8HI6HRORVyQPfUg3UCc8w+LG3mQiEzV1nyX/vx9l8\n\t n1swd/n218OorPZ2COOuGSluDcHVsWOhVuni4aBhAlNVDYJa8eIppGes6KGEXeLkGO\n\t jO09yfYEBS58A==\nReceived: from www-data (helo=bmconsumera) by www.boondmanager.com with local-smtp (Exim 4.92) (envelope-from <no-reply@boondmanager.com>) id 1mU4ao-000ROd-RK for depotdesign@gmail.com; Sat, 25 Sep 2021 12:07:38 +0200\nMessage-ID: <2bd79a797121796a5647b0595b4eda37@bmconsumera>\nDate: Sat, 25 Sep 2021 12:07:38 +0200\nSubject: Saisie des Temps\nFrom: BoondManager <no-reply@boondmanager.com>\nTo: Anthony MOUTTE <depotdesign@gmail.com>\nMIME-Version: 1.0\nContent-Type: multipart/alternative; boundary=\"_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\"\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\nContent-Type: text/plain; charset=utf-8\nContent-Transfer-Encoding: quoted-printable\n\nBonjour Anthony MOUTTE,\n\nVeuillez vous connecter =C3=A0 l'intranet de votre soci=C3=A9t=C3=A9, depui=\ns\nl'adresse suivante :\nhttps://ui.boondmanager.com?customerCode=3Dgroupeeleven afin de saisir\nvos temps du mois en cours.\n\nSi vous ne disposez pas de vos identifiants de connexion, veuillez\ncontacter votre responsable.\n\nMerci de ne pas r=C3=A9pondre =C3=A0 cet email.\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_\nContent-Type: text/html; charset=utf-8\nContent-Transfer-Encoding: quoted-printable\n\n<!DOCTYPE html>\n<html lang=3D\"en\">\n<head>\n=09<meta charset=3D\"UTF-8\">\n=09<title>Title</title>\n=09<style>\n=09=09@media screen and (max-width:1200px) {\n=09=09=09.mobile {\n=09=09=09=09padding: 10px !important;\n=09=09=09=09font-size: 14px !important;\n=09=09=09}\n=09=09=09h2 {\n=09=09=09=09font-size:16px !important;\n=09=09=09}\n=09=09}\n=09</style>\n</head>\n<body class=3D'mobile' style=3D\"background-color: #EDF2FA;font-size: 14px;p=\nadding: 32px 48px 40px 48px;color: #707070;text-align: left;letter-spacing:=\n 0;\">\n=09<table class=3D'mobile'  style=3D\"font-family: Arial !important;max-widt=\nh: 887px;width: 100%;background-color: #FFFFFF;background-origin: padding-b=\nox;background-repeat: no-repeat;border-radius:08px;padding:40px;margin:auto=\n;\">\n=09=09=09=09<tr>\n=09=09=09<td width=3D\"100%\"><center><img style=3D\"margin-bottom: 40px;\" hei=\nght=3D\"40\" src=3D\"https://ui.boondmanager.com/img/_clients/groupeeleven/log=\no.png\" alt=3D\"logo\"></center></td>\n=09=09</tr>\n=09=09=09=09<tr >\n=09=09=09<td style=3D\"font-family: Arial !important;\">Bonjour Anthony MOUTT=\nE,<br />\n<br />\nVeuillez vous connecter =C3=A0 l'intranet de votre soci=C3=A9t=C3=A9, depui=\ns l'adresse suivante : https://ui.boondmanager.com?customerCode=3Dgroupeele=\nven afin de saisir vos temps du mois en cours.<br />\n<br />\nSi vous ne disposez pas de vos identifiants de connexion, veuillez contacte=\nr votre responsable.<br />\n<br />\nMerci de ne pas r=C3=A9pondre =C3=A0 cet email.</td>\n=09=09</tr>\n=09=09<tr height=3D\"40px\"><td>&nbsp;</td></tr>\n=09=09<tr>\n=09=09=09<td width=3D\"100%\" style=3D\"text-align: right; font-family: Arial =\n!important;\">\n=09=09=09=09<a href=3D\"https://www.boondmanager.com/\" style=3D\"text-decorat=\nion: none;color: #707070;\">\n=09=09=09=09=09<p style=3D\"font-size: 12px; display: inline-block; margin: =\n0px;\"><i>Powered by </i><span style=3D\"font-size: 14px; color: black;\"><str=\nong>Boond</strong></span><span style=3D\"font-size: 14px;color: #FEA500;\">Ma=\nnager</span></p>\n=09=09=09=09</a>\n=09=09=09</td>\n=09=09</tr>\n=09</table>\n=09<br><br>\n</body>\n</html>\n\n\n--_=_swift_1632564458_491cf77ffbbcea048e549e6a08c2135c_=_--",
	})

	g := container.GetStopDispatcher()
	g.RegisterEmitter(
		stop_emitter.DefaultKillerSignalEmitter(),
		http.StartServerShutdownEmitter(container.GetHTTPServer(), l),
		smtp.StartServerShutdownEmitter(container.GetSMTPServer(), l),
	)

	if err := g.Wait(mainCtx); err != nil {
		log.Printf("error occured during stopping application : %s", err)
	}
	mainCancel()
}
